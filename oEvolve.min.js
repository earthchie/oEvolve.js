/**
 * @name oEvolve.js
 * @version 1.0.0
 * @update June 8, 2017
 * @website https://github.com/earthchie/oEvolve.js
 * @author Earthchie https://facebook.com/earthchie/
 * @license WTFPL v.2 - http://www.wtfpl.net/
 **/
function oEvolve(t,e){"use strict";t=t||{},(e=e||{}).proto=e.proto||{},void 0===e.deep&&(e.deep=10);var n,i=e.proto,r=function(t,e,n){return i[e]=n,Object.setPrototypeOf(t,i),t};if(r(t,"__clone",function(t){return void 0===t&&(t=!1),t?new oEvolve(JSON.parse(this.toString()),i):new oEvolve(JSON.parse(this.toString()))}),r(t,"__data",function(){return JSON.parse(this.toString())}),r(t,"__diff",function(t,e){return void 0===e&&(e=t||{},t=this),t.__isEvolved&&(t=t.__data()),e.__isEvolved&&(e=e.__data()),oEvolve.diff(t,e)}),r(t,"__isEqual",function(t){return oEvolve.isEqual(this.__data(),t)}),r(t,"__inflate",function(t){return oEvolve.inflate(t||this.__data())}),r(t,"__deflate",function(t){return oEvolve.deflate(t||this.__data())}),r(t,"__get",function(t){return oEvolve.get(this,t)}),r(t,"__unbindAll",function(t,e){r(this,"__bindListeners",[])}),r(t,"__bind",function(t,e){if(void 0===e&&t instanceof HTMLElement&&(e=t,t=!1),e instanceof HTMLElement){var n=e.innerHTML,i=this;return r(i,"__ref",i),e.innerHTML=i.toString(n),i.__bindListeners||r(i,"__bindListeners",[]),i.__bindListeners.push(function(){e instanceof HTMLElement&&("function"==typeof t&&(i=new oEvolve(t(i.__data())||i.__data())),e.innerHTML=i.toString(n))}),{binder_id:i.__bindListeners.length-1,unbind:function(){i.__bindListeners[this.binder_id]&&i.__bindListeners.splice(this.binder_id,1)}}}}),r(t,"__set",function(t,e){oEvolve.set(this,t,e)}),r(t,"toString",function(t){var e,n,i;return"string"==typeof t&&""!==t?(e=this,i=t,((i.match(/\{\{(.*?)\}\}/g)||[]).map(function(t){return t.replace(/\{|\}/g,"")})||[]).map(function(t){(n=t.split("||"))[1]=n[1]||"",i=i.replace(new RegExp("{{"+t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"}}","g"),e.__get(n[0])||n[1])}),i):!0===t?JSON.stringify(this,"",2):JSON.stringify(this)}),r(t,"toObject",function(){return this.__data()}),r(t,"addEventListener",function(t,e){var n=this,i={},o=["watch","create","update","delete"],s=!1;if(r(n,"__ref",n),t.split(" ").forEach(function(t){if(o.indexOf(t)>-1){var a,f="__"+t+"Listeners";n[f]||r(n,f,{}),a=e.name||Object.keys(n[f]).length,i[f]||(i[f]=[]),i[f].push(a),n[f][a]=e,s=s||!0}}),s)return{listeners:i,removeEventListener:function(){var t,e=this.listeners;for(t in e)e.hasOwnProperty(t)&&n[t]&&e[t].forEach(function(e){delete n[t][e]})}};console.warn("addEventListener only support:",o.join(", "))}),r(t,"removeEventListener",function(t,e){var n=this;r(n,"__ref",n),t.split(" ").forEach(function(t){var i="__"+t+"Listeners";n[i]&&"function"==typeof e&&n[i][e.name]&&delete n[i][e.name]})}),r(t,"removeAllEventListeners",function(t,e){var n=this;r(n,"__ref",n),t.split(" ").forEach(function(t){var e="__"+t+"Listeners";n[e]&&r(n,e,{})})}),t=new Proxy(t,{get:function(t,e){return"length"===e?Object.keys(t).length:"__isEvolved"===e||t[e]},set:function(t,e,n){var i,r,o,s,a,f,u={watch:!0,bind:!0,create:!1,update:!1,delete:!1};t.__ref&&(i=t.__ref.__data()),t[e]=n,t.__ref&&(r=t.__ref.__data()),o=oEvolve.diff(i,r);for(s in o)o.hasOwnProperty(s)&&(u[o[s]]=u[o[s]]||!0);for(s in u)if(u.hasOwnProperty(s)&&u[s]){f=t["__"+s+"Listeners"];for(a in f)"function"==typeof f[a]&&f[a](r,i,o)}return n},deleteProperty:function(t,e){if(t.hasOwnProperty(e)){var n,i,r,o,s,a,f={watch:!0,bind:!0,create:!1,update:!1,delete:!1};t.__ref&&(n=t.__ref.__data()),delete t[e],t.__ref&&(i=t.__ref.__data()),r=oEvolve.diff(n,i);for(s in r)r.hasOwnProperty(s)&&(f[r[s]]=f[r[s]]||!0);for(s in f)if(f.hasOwnProperty(s)&&f[s]){a=t["__"+s+"Listeners"];for(o in a)"function"==typeof a[o]&&a[o](i,n,r)}return!0}}}),e.deep){isNaN(e.deep)||(e.deep=e.deep-1);for(n in t)t.hasOwnProperty(n)&&t[n]instanceof Object&&(t[n]=new oEvolve(t[n],e))}return t}oEvolve.diff=function(t,e){"use strict";var n,i={VALUE_CREATED:"create",VALUE_UPDATED:"update",VALUE_DELETED:"delete",VALUE_UNCHANGED:"unchanged",map:function(t,e){var n,i,r;if(this.isFunction(t)||this.isFunction(e))throw"Invalid argument. Function given, object expected.";if(this.isValue(t)||this.isValue(e))return this.compareValues(t,e);i={};for(n in t)t.hasOwnProperty(n)&&!this.isFunction(t[n])&&(r=void 0,void 0!==e[n]&&(r=e[n]),i[n]=this.map(t[n],r));for(n in e)e.hasOwnProperty(n)&&!this.isFunction(e[n])&&void 0===i[n]&&(i[n]=this.map(void 0,e[n]));return i},compareValues:function(t,e){return t===e?this.VALUE_UNCHANGED:this.isDate(t)&&this.isDate(e)&&t.getTime()===e.getTime()?this.VALUE_UNCHANGED:void 0===t?this.VALUE_CREATED:void 0===e?this.VALUE_DELETED:this.VALUE_UPDATED},isFunction:function(t){return"[object Function]"==={}.toString.apply(t)},isArray:function(t){return"[object Array]"==={}.toString.apply(t)},isObject:function(t){return"[object Object]"==={}.toString.apply(t)},isDate:function(t){return"[object Date]"==={}.toString.apply(t)},isValue:function(t){return!this.isObject(t)&&!this.isArray(t)}},r=oEvolve.deflate(i.map(t||{},e||{}));for(n in r)"unchanged"===r[n]&&delete r[n];return r},oEvolve.get=function(t,e){"use strict";for(e=e.replace(/\[(\w+)\]/g,".$1").split(".");t&&e.length>0;)t=t[e.shift()];return t},oEvolve.set=function(t,e,n){"use strict";var i=t,r=function(t,e,n){n||(n=i);var o=t.replace(/\[(\w+)\]/g,".$1").split(/\./);o.length<2?(n[o[0]],n[o[0]]=e):(n[o[0]]||(n[o[0]]={}),n=n[o.shift()],r(o.join("."),e,n))};return r(e,n),i},oEvolve.inflate=function(t){"use strict";var e,n={};for(e in t)t.hasOwnProperty(e)&&oEvolve.set(n,e,t[e]);return n},oEvolve.deflate=function(t){"use strict";var e=function(t){var n,i,r,o={};for(n in t)if(t.hasOwnProperty(n))if("object"==typeof t[n]){r=e(t[n]);for(i in r)r.hasOwnProperty(i)&&(o[n+"."+i]=r[i])}else o[n]=t[n];return o};return e(t)},oEvolve.isEqual=function(t,e){"use strict";return!(t instanceof Function)&&t instanceof Object&&!(e instanceof Function)&&e instanceof Object&&JSON.stringify(t)===JSON.stringify(e)};