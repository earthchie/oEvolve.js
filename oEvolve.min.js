/**
 * @name oEvolve.js
 * @version 1.0.1
 * @update June 8, 2017
 * @website https://github.com/earthchie/oEvolve.js
 * @author Earthchie https://facebook.com/earthchie/
 * @license WTFPL v.2 - http://www.wtfpl.net/
 **/
function oEvolve(e,t){"use strict";e=e||{},(t=t||{}).proto=t.proto||{},void 0===t.deep&&(t.deep=10);var n,i=t.proto,r=function(e,t,n){return i[t]=n,Object.setPrototypeOf(e,i),e};if(r(e,"__clone",function(e){return void 0===e&&(e=!1),e?new oEvolve(JSON.parse(this.toString()),{proto:i,deep:t.deep}):new oEvolve(JSON.parse(this.toString()),{deep:t.deep})}),r(e,"__data",function(){return JSON.parse(this.toString())}),r(e,"__diff",function(e,t){return void 0===t&&(t=e||{},e=this),e.__isEvolved&&(e=e.__data()),t.__isEvolved&&(t=t.__data()),oEvolve.diff(e,t)}),r(e,"__isEqual",function(e){return oEvolve.isEqual(this.__data(),e)}),r(e,"__inflate",function(e){return oEvolve.inflate(e||this.__data())}),r(e,"__deflate",function(e){return oEvolve.deflate(e||this.__data())}),r(e,"__get",function(e){return oEvolve.get(this,e)}),r(e,"__unbindAll",function(){r(this,"__bindListeners",[])}),r(e,"__bind",function(e,n){if(void 0===n&&e instanceof HTMLElement&&(n=e,e=!1),n instanceof HTMLElement){var i=n.innerHTML,o=this;return r(o,"__ref",o),n.innerHTML=o.toString(i),o.__bindListeners||r(o,"__bindListeners",[]),o.__bindListeners.push(function(){n instanceof HTMLElement&&("function"==typeof e&&(o=new oEvolve(e(o.__data())||o.__data(),{deep:t.deep})),n.innerHTML=o.toString(i))}),{binder_id:o.__bindListeners.length-1,unbind:function(){o.__bindListeners[this.binder_id]&&o.__bindListeners.splice(this.binder_id,1)}}}}),r(e,"__set",function(e,t){oEvolve.set(this,e,t)}),r(e,"toString",function(e){var t,n,i;return"string"==typeof e&&""!==e?(t=this,i=e,((i.match(/\{\{(.*?)\}\}/g)||[]).map(function(e){return e.replace(/\{|\}/g,"")})||[]).map(function(e){(n=e.split("||"))[1]=n[1]||"",i=i.replace(new RegExp("{{"+e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"}}","g"),t.__get(n[0])||n[1])}),i):!0===e?JSON.stringify(this,"",2):JSON.stringify(this)}),r(e,"toObject",function(){return this.__data()}),r(e,"addEventListener",function(e,t){var n=this,i={},o=["watch","create","update","delete"],s=!1;if(r(n,"__ref",n),e.split(" ").forEach(function(e){if(o.indexOf(e)>-1){var a,f="__"+e+"Listeners";n[f]||r(n,f,{}),a=t.name||Object.keys(n[f]).length,i[f]||(i[f]=[]),i[f].push(a),n[f][a]=t,s=s||!0}}),s)return{listeners:i,removeEventListener:function(){var e,t=this.listeners;for(e in t)t.hasOwnProperty(e)&&n[e]&&t[e].forEach(function(t){delete n[e][t]})}};console.warn("addEventListener only support:",o.join(", "))}),r(e,"removeEventListener",function(e,t){var n=this;r(n,"__ref",n),e.split(" ").forEach(function(e){var i="__"+e+"Listeners";n[i]&&"function"==typeof t&&n[i][t.name]&&delete n[i][t.name]})}),r(e,"removeAllEventListeners",function(e){var t=this;r(t,"__ref",t),e.split(" ").forEach(function(e){var n="__"+e+"Listeners";t[n]&&r(t,n,{})})}),e=new Proxy(e,{get:function(e,t){return"length"===t?Object.keys(e).length:"__isEvolved"===t||e[t]},set:function(e,t,n){var i,r,o,s,a,f,u={watch:!0,bind:!0,create:!1,update:!1,delete:!1};e.__ref&&(i=e.__ref.__data()),e[t]=n,e.__ref&&(r=e.__ref.__data()),o=oEvolve.diff(i,r);for(s in o)o.hasOwnProperty(s)&&(u[o[s]]=u[o[s]]||!0);for(s in u)if(u.hasOwnProperty(s)&&u[s]){f=e["__"+s+"Listeners"];for(a in f)"function"==typeof f[a]&&f[a](r,i,o)}return n},deleteProperty:function(e,t){if(e.hasOwnProperty(t)){var n,i,r,o,s,a,f={watch:!0,bind:!0,create:!1,update:!1,delete:!1};e.__ref&&(n=e.__ref.__data()),delete e[t],e.__ref&&(i=e.__ref.__data()),r=oEvolve.diff(n,i);for(s in r)r.hasOwnProperty(s)&&(f[r[s]]=f[r[s]]||!0);for(s in f)if(f.hasOwnProperty(s)&&f[s]){a=e["__"+s+"Listeners"];for(o in a)"function"==typeof a[o]&&a[o](i,n,r)}return!0}}}),t.deep){isNaN(t.deep)||(t.deep=t.deep-1);for(n in e)e.hasOwnProperty(n)&&e[n]instanceof Object&&(e[n]=new oEvolve(e[n],t))}return e}oEvolve.diff=function(e,t){"use strict";var n,i={VALUE_CREATED:"create",VALUE_UPDATED:"update",VALUE_DELETED:"delete",VALUE_UNCHANGED:"unchanged",map:function(e,t){var n,i,r;if(this.isFunction(e)||this.isFunction(t))throw"Invalid argument. Function given, object expected.";if(this.isValue(e)||this.isValue(t))return this.compareValues(e,t);i={};for(n in e)e.hasOwnProperty(n)&&!this.isFunction(e[n])&&(r=void 0,void 0!==t[n]&&(r=t[n]),i[n]=this.map(e[n],r));for(n in t)t.hasOwnProperty(n)&&!this.isFunction(t[n])&&void 0===i[n]&&(i[n]=this.map(void 0,t[n]));return i},compareValues:function(e,t){return e===t?this.VALUE_UNCHANGED:this.isDate(e)&&this.isDate(t)&&e.getTime()===t.getTime()?this.VALUE_UNCHANGED:void 0===e?this.VALUE_CREATED:void 0===t?this.VALUE_DELETED:this.VALUE_UPDATED},isFunction:function(e){return"[object Function]"==={}.toString.apply(e)},isArray:function(e){return"[object Array]"==={}.toString.apply(e)},isObject:function(e){return"[object Object]"==={}.toString.apply(e)},isDate:function(e){return"[object Date]"==={}.toString.apply(e)},isValue:function(e){return!this.isObject(e)&&!this.isArray(e)}},r=oEvolve.deflate(i.map(e||{},t||{}));for(n in r)"unchanged"===r[n]&&delete r[n];return r},oEvolve.get=function(e,t){"use strict";for(t=t.replace(/\[(\w+)\]/g,".$1").split(".");e&&t.length>0;)e=e[t.shift()];return e},oEvolve.set=function(e,t,n){"use strict";var i=e,r=function(e,t,n){n||(n=i);var o=e.replace(/\[(\w+)\]/g,".$1").split(/\./);o.length<2?(n[o[0]],n[o[0]]=t):(n[o[0]]||(n[o[0]]={}),n=n[o.shift()],r(o.join("."),t,n))};return r(t,n),i},oEvolve.inflate=function(e){"use strict";var t,n={};for(t in e)e.hasOwnProperty(t)&&oEvolve.set(n,t,e[t]);return n},oEvolve.deflate=function(e){"use strict";var t=function(e){var n,i,r,o={};for(n in e)if(e.hasOwnProperty(n))if("object"==typeof e[n]){r=t(e[n]);for(i in r)r.hasOwnProperty(i)&&(o[n+"."+i]=r[i])}else o[n]=e[n];return o};return t(e)},oEvolve.isEqual=function(e,t){"use strict";return!(e instanceof Function)&&e instanceof Object&&!(t instanceof Function)&&t instanceof Object&&JSON.stringify(e)===JSON.stringify(t)};